<!DOCTYPE html>
<html>

<head>
    <title>Harvard Voice Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #status {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #f0f0f0;
            font-size: 16px;
        }

        .connected {
            background: #d4edda !important;
            color: #155724;
        }

        .error {
            background: #f8d7da !important;
            color: #721c24;
        }

        .warning {
            background: #fff3cd !important;
            color: #856404;
        }
    </style>
</head>

<body>
    <h1>ğŸ“ Harvard Voice Assistant</h1>
    <p>Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ Ø°ÙƒÙŠ Ù„Ø¬Ø§Ù…Ø¹Ø© Ù‡Ø§Ø±ÙØ§Ø±Ø¯</p>

    <button id="connectBtn">ğŸ¤ Ø§ØªØµÙ„ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø¯ÙŠØ«</button>
    <button id="disconnectBtn" disabled>âŒ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>

    <div id="status">ØºÙŠØ± Ù…ØªØµÙ„</div>
    <div id="audioContainer"></div>

    <script type="module">
        import { Room, RoomEvent, Track } from 'https://unpkg.com/livekit-client@2.5.8/dist/livekit-client.esm.mjs';

        const API_URL = 'http://localhost:8000';

        let room = null;
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const audioContainer = document.getElementById('audioContainer');

        function updateStatus(message, type = '') {
            statusDiv.textContent = message;
            statusDiv.className = type;
            console.log('ğŸ“¢', message);
        }

        connectBtn.onclick = async () => {
            try {
                connectBtn.disabled = true;
                updateStatus('ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...', 'warning');

                // STEP 1: Request microphone permission FIRST
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                        }
                    });
                    updateStatus('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'connected');
                    console.log('âœ… Microphone access granted');
                } catch (err) {
                    updateStatus('âŒ Ø±ÙÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†! ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'error');
                    console.error('âŒ Microphone permission denied:', err);
                    connectBtn.disabled = false;
                    return;
                }

                // STEP 2: Request token from FastAPI
                updateStatus('ğŸ”‘ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø§Ù„Ø§ØªØµØ§Ù„...', 'warning');

                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_name: 'harvard-voice-room',
                        participant_name: `user-${Date.now()}`
                    })
                });

                if (!response.ok) {
                    throw new Error(`ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²: ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ… Token received:', data);

                // STEP 3: Create room and connect
                updateStatus('ğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØºØ±ÙØ©...', 'warning');

                room = new Room({
                    adaptiveStream: true,
                    dynacast: true,
                    audioCaptureDefaults: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                    },
                });

                // Set up event handlers BEFORE connecting
                room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    console.log('ğŸµ Track subscribed:', track.kind, 'from', participant.identity);

                    if (track.kind === Track.Kind.Audio) {
                        const audioElement = track.attach();
                        audioElement.autoplay = true;
                        audioElement.volume = 1.0;
                        audioContainer.appendChild(audioElement);

                        console.log('ğŸ”Š Audio track attached and playing');
                        updateStatus('ğŸ”Š Ù…ØªØµÙ„! Ø§Ù„ØµÙˆØª Ù†Ø´Ø· - ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†', 'connected');
                    }
                });

                room.on(RoomEvent.TrackUnsubscribed, (track) => {
                    console.log('ğŸ”‡ Track unsubscribed:', track.kind);
                    track.detach().forEach(element => element.remove());
                });

                room.on(RoomEvent.Disconnected, (reason) => {
                    console.log('âŒ Disconnected:', reason);
                    updateStatus('Ù‚ÙØ·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', '');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    audioContainer.innerHTML = '';

                    // Stop microphone stream
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                });

                room.on(RoomEvent.Connected, () => {
                    console.log('âœ… Successfully connected to room');
                    updateStatus('âœ… Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'connected');
                });

                room.on(RoomEvent.ParticipantConnected, (participant) => {
                    console.log('ğŸ‘¤ Participant connected:', participant.identity);
                });

                // STEP 4: Connect to LiveKit room
                console.log('Connecting to:', data.url);
                await room.connect(data.url, data.token);

                // STEP 5: Enable microphone
                updateStatus('ğŸ¤ Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...', 'warning');
                await room.localParticipant.setMicrophoneEnabled(true);

                updateStatus('ğŸ¤ Ù…ØªØµÙ„! ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù† ÙˆØ³ÙŠØ±Ø¯ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯', 'connected');
                disconnectBtn.disabled = false;

                console.log('âœ… All set! Ready to talk');

            } catch (error) {
                console.error('âŒ Connection error:', error);
                updateStatus(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                connectBtn.disabled = false;

                // Clean up on error
                if (room) {
                    room.disconnect();
                    room = null;
                }
            }
        };

        disconnectBtn.onclick = () => {
            if (room) {
                console.log('Disconnecting...');
                room.disconnect();
                room = null;
            }
        };

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (room) {
                room.disconnect();
            }
        });
    </script>
</body>

</html>